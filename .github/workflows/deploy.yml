name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Deploy via SSH using GitHub secret directly
      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: 72.61.237.199
          username: sarthakedge1
          key: ${{ secrets.SSH_KEY }}      # Use GitHub secret
          script: |
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            BACKUP_DIR=/home/sarthakedge1/htdocs/beta.sarthakedge.com_backup_$TIMESTAMP

            # Backup existing site
            cp -r /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code $BACKUP_DIR

            # Deploy new code
            rsync -avz --delete --exclude=".git" --exclude="node_modules" ./ /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/

            # Create a text file
            echo "This is some text content" > /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/yash.txt

            # Set ownership and permissions
            chown -R sarthakedge1:sarthakedge1 /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code
            find /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code -type d -exec chmod 755 {} \;
            find /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code -type f -exec chmod 644 {} \;

            # Laravel storage & cache permissions
            mkdir -p /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/framework/cache \
                     /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/framework/views \
                     /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/logs \
                     /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/bootstrap/cache \
                     /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/tmp \
                     /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/.cache
            chmod -R 775 /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage \
                         /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/bootstrap/cache \
                         /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/tmp \
                         /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/.cache

            # Clear Laravel cache and logs
            rm -rf /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/framework/cache/*
            rm -rf /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/framework/views/*
            rm -rf /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/storage/logs/*.log
            rm -rf /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/tmp/*
            rm -rf /home/sarthakedge1/htdocs/beta.sarthakedge.com/php_code/.cache/*

            # Restart PHP-FPM
            sudo systemctl restart php8.1-fpm
